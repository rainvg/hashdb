"use strict";function hashdb(e){var t=e,r=!fs.existsSync(t),n=new sqlite3.Database(t);r&&n.serialize(function(){n.run("begin"),n.run("create table `items` (`idx` bigint unique, `merkle` char(64), `tag` text unique, `digest` char(64))"),n.run("create table `updates` (`version` integer primary key autoincrement, `remove` tinyint(1), `tag` text, `digest` char(64))"),n.run("commit")});var i=(this.path=function(){return t},this.root=function(){return new Promise(function(e,t){n.get("select `merkle` from items where `idx` = 1",function(r,n){return r?void t(r):n?void e(n.merkle):void e("e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855")})})},this.version=function(){return new Promise(function(e,t){n.get("select max(`version`) as version from updates",function(r,n){return r?void t(r):n.version?void e(n.version):void e(0)})})},function(e){var t=crypto.createHash("sha256");t.update(e.tag),t.update(e.digest);var r=t.digest("hex");return t=crypto.createHash("sha256"),t.update(r),t.update(e.left_merkle),t.update(e.right_merkle),t.digest("hex")}),o=function(e){return 0===e?Promise.resolve():new Promise(function(t,r){n.get("select parent.`tag` as tag, parent.`digest` as digest, coalesce(left.`merkle`, 'e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855') as left_merkle, coalesce(right.`merkle`, 'e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855') as right_merkle from items as parent left join items as left on left.`idx` = 2 * parent.`idx` left join items as right on right.`idx` = 2 * parent.`idx` + 1 where parent.`idx` = ?",e,function(o,a){(o||!a)&&r(o),n.run("update items set merkle = ? where idx = ?",i(a),e,function(e){return e?void r(e):void t()})})}).then(function(){return o(Math.floor(e/2))})};this.add=function(e,t){var r;return new Promise(function(i,o){n.serialize(function(){try{n.run("begin"),n.run("insert into updates values (null, 0, ?, ?)",e,t),n.get("select count(*) as count from items",function(a,c){return a?void o(a):(r=c.count+1,void n.run("insert into items values (?, null, ?, ?)",r,e,t,function(e){return e?void o(e):void i()}))})}catch(a){o(a)}})}).then(function(){return o(r)}).then(function(){return new Promise(function(e,t){n.run("commit",function(r){return r?void t(r):void e()})})})["catch"](function(e){return n.run("rollback"),Promise.reject(e)})},this.remove=function(e){var t,r;return new Promise(function(i,o){n.serialize(function(){try{n.run("begin"),n.run("insert into updates values(null, 1, ?, null)"),n.get("select rem.`idx` as remidx, max(mov.`idx`) as movidx from items as rem, items as mov where rem.tag = ?",e,function(e,a){(e||!a)&&o(e),t=a.remidx,r=a.movidx,n.run("delete from items where idx = ?",t,function(e){return e?void o(e):t!==r?void n.run("update items set idx = ? where idx = ?",t,r,function(e){return e?void o(e):void i()}):void i()})})}catch(a){o(a)}})}).then(function(){return o(Math.floor(r/2))}).then(function(){return t!==r?o(t):void 0}).then(function(){return new Promise(function(e,t){n.run("commit",function(r){return r?void t(r):void e()})})})["catch"](function(e){return n.run("rollback"),Promise.reject(e)})},this.prove=function(e){var t=[];return new Promise(function(r,i){function o(e){return 0===e?void r(t):void n.get("select parent.`tag` as tag, parent.`digest` as digest, coalesce(left.`merkle`, 'e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855') as left_merkle, coalesce(right.`merkle`, 'e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855') as right_merkle from items as parent left join items as left on left.`idx` = 2 * parent.`idx` left join items as right on right.`idx` = 2 * parent.`idx` + 1 where parent.`idx` = ?",e,function(r,n){(r||!n)&&i(r),t.push({tag:n.tag,digest:n.digest,left_merkle:n.left_merkle,right_merkle:n.right_merkle}),o(Math.floor(e/2))})}n.get("select idx from items where tag = ?",e,function(e,t){return e||!t?void i(e):void o(t.idx)})})}}function check(e,t){var r=null;for(var n in t){if(r&&r!==t[n].left_merkle&&r!==t[n].right_merkle)return!1;r=__compute_merkle__(t[n])}return e===r}var sqlite3=require("sqlite3").verbose(),crypto=require("crypto"),fs=require("fs");module.exports={hashdb:hashdb,check:check};